name: Build External Repo Docker Image

on:
  # Scheduled builds - customize the cron schedule as needed
  # schedule:
  #   # Daily at 2:00 AM UTC
  #   - cron: '0 2 1 * *'
  #   # Weekly on Monday at 2:00 AM UTC
  #   # - cron: '0 2 * * 1'
  #   # Monthly on the 1st at 2:00 AM UTC
  #   # - cron: '0 2 1 * *'
  
  # Trigger on push to main branch
  push:
    branches:
      - master
  
  # Manual trigger with optional overrides
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'Source repository (e.g., https://git.lolcat.ca/lolcat/4get or owner/repo for GitHub)'
        required: false
        type: string
      source_branch:
        description: 'Branch to build from'
        required: false
        type: string
        default: 'master'
      custom_tag:
        description: 'Custom tag (optional, in addition to date tags)'
        required: false
        type: string

env:
  # CUSTOMIZE THIS: Source repository to clone and build (full URL or GitHub owner/repo)
  SOURCE_REPO: https://github.com/rinkwarez/GatherAt-frontend
  
  # CUSTOMIZE THIS: Branch to build from
  SOURCE_BRANCH: master
  
  # CUSTOMIZE THIS: Your GHCR package name
  GHCR_IMAGE_NAME: ghcr.io/rinkwarez/gatherat-frontend
  
  # CUSTOMIZE THIS: Path to Dockerfile in the source repo
  DOCKERFILE_PATH: ./Dockerfile
  
  # CUSTOMIZE THIS: Build context path
  BUILD_CONTEXT: .

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Set repository and branch
        id: repo_info
        run: |
          if [ -n "${{ github.event.inputs.source_repo }}" ]; then
            REPO="${{ github.event.inputs.source_repo }}"
          else
            REPO="${{ env.SOURCE_REPO }}"
          fi
          
          # Add https:// if not present and not a GitHub repo
          if [[ ! "$REPO" =~ ^https?:// ]] && [[ ! "$REPO" =~ ^git@ ]] && [[ "$REPO" =~ / ]]; then
            if [[ "$REPO" =~ github\.com ]]; then
              REPO="https://github.com/${REPO}"
            else
              REPO="https://${REPO}"
            fi
          fi
          
          echo "repo=$REPO" >> $GITHUB_OUTPUT
          
          if [ -n "${{ github.event.inputs.source_branch }}" ]; then
            echo "branch=${{ github.event.inputs.source_branch }}" >> $GITHUB_OUTPUT
          else
            echo "branch=${{ env.SOURCE_BRANCH }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Clone source repository
        run: |
          echo "Cloning repository: ${{ steps.repo_info.outputs.repo }}"
          echo "Branch: ${{ steps.repo_info.outputs.branch }}"
          
          # Parse repository URL and inject PAT if available
          REPO_URL="${{ steps.repo_info.outputs.repo }}"
          if [ -n "${{ secrets.SOURCE_REPO_PAT }}" ]; then
            # For GitHub URLs, inject the PAT
            if [[ "$REPO_URL" =~ ^https://github.com/ ]]; then
              REPO_URL=$(echo "$REPO_URL" | sed "s|https://github.com/|https://${{ secrets.SOURCE_REPO_PAT }}@github.com/|")
            elif [[ "$REPO_URL" =~ ^https:// ]]; then
              # For other HTTPS URLs, inject PAT after https://
              REPO_URL=$(echo "$REPO_URL" | sed "s|https://|https://${{ secrets.SOURCE_REPO_PAT }}@|")
            fi
          fi
          
          git clone --depth 1 --branch ${{ steps.repo_info.outputs.branch }} \
            "$REPO_URL" ./repo
          
          cd ./repo
          echo "Repository cloned successfully"
          echo "Current directory contents:"
          ls -la
      
      - name: Get commit SHA
        id: commit
        run: |
          cd ./repo
          COMMIT_SHA=$(git rev-parse --short HEAD)
          echo "sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "Commit SHA: $COMMIT_SHA"
      
      - name: Check Dockerfile exists
        run: |
          cd ./repo
          if [ ! -f "${{ env.DOCKERFILE_PATH }}" ]; then
            echo "Error: Dockerfile not found at ${{ env.DOCKERFILE_PATH }}"
            echo "Available files in repository root:"
            ls -la
            echo ""
            echo "Searching for Dockerfile in subdirectories:"
            find . -name "Dockerfile" -o -name "dockerfile"
            exit 1
          fi
          echo "âœ“ Dockerfile found at ${{ env.DOCKERFILE_PATH }}"
          echo "Building from repository: ${{ steps.repo_info.outputs.repo }}"
          echo "Building from branch: ${{ steps.repo_info.outputs.branch }}"
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.GHCR_IMAGE_NAME }}
          tags: |
            type=raw,value=latest
            type=raw,value=${{ steps.commit.outputs.sha }}
            type=raw,value=${{ github.event.inputs.custom_tag }},enable=${{ github.event.inputs.custom_tag != '' }}
          labels: |
            org.opencontainers.image.source=${{ steps.repo_info.outputs.repo }}
            org.opencontainers.image.description=Built from ${{ steps.repo_info.outputs.repo }}@${{ steps.repo_info.outputs.branch }}
            org.opencontainers.image.revision=${{ steps.commit.outputs.sha }}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./repo/${{ env.BUILD_CONTEXT }}
          file: ./repo/${{ env.DOCKERFILE_PATH }}
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Output build summary
        run: |
          echo "## Build Summary :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Source Repository:** \`${{ steps.repo_info.outputs.repo }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ steps.repo_info.outputs.branch }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit SHA:** \`${{ steps.commit.outputs.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Target Image:** \`${{ env.GHCR_IMAGE_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Platforms:** \`linux/amd64, linux/arm64\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tags" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" | tr ',' '\n' >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
